basedir <- "~/RA/PPDK/PPDK_lw"
dir1 <- "~/RA/PPDK/PPDK_lw/lwoutput"
dir2 <- "~/RA/PPDK/PPDK_lw/lwoutput2"

files1 <- grep("gene_RPKM", dir(dir1, full.names = TRUE), value = TRUE)
files2 <- grep("gene_RPKM", dir(dir2, full.names = TRUE), value = TRUE)
files <- c(files1, files2)

fileidx <- seq(1, length(files), 2)
n <- tail(fileidx, 1)

for(i in fileidx){

    ## Grab name of stuff we're working with
    name <- gsub("_trim.*", "", gsub(".*PPDK_", "", files[i+1]))
    cat(i, "/", n, "- Operating on:", name, format(Sys.time()),"\n")
    flush.console()

    antisense <- read.table(files[i], sep="\t", header = TRUE, stringsAsFactors = FALSE)

    sense <- read.table(files[i+1], sep="\t", header = TRUE, stringsAsFactors = FALSE)

    ## Grab transcript and coverage
    antisense <- antisense[,c(2,5)]
    sense <- sense[,c(2,5)]

        ## Merge to make sure transcript name matches
    j <- merge(sense, antisense, by.x = "TRANSCRIPT", by.y = "TRANSCRIPT")

    ## If merging ends up in different dimension we have a problem
    if(dim(j)[1] != dim(sense)[1]){
        warning(paste("Merged data has different dimension:", name))
    }

      ## Plot sense v. antisense
    png(filename = paste(basedir, "/Plots/", name, ".png", sep = ""))
    plot(j[,2],
         j[,3],
         main = name,
         xlab = "Sense",
         ylab= "Antisense",
         col=rgb(0,100,0,50,maxColorValue=255),
         pch = 16)
    abline(0, 1)
    dev.off()

    ## We only care about the sum
    j$COVERAGE <- j[,2] + j[,3]
    j <- j[,c("TRANSCRIPT", "COVERAGE")]

    write.csv(j, file = paste(basedir, "/ReducedData/", name, ".csv", sep = ""), row.names = FALSE)

}

## Check to make sure transcript names are the same
##j1 <- read.csv(paste(basedir, "/ReducedData/HL3_WT_Tip.csv", sep = ""), header = T)
##j2 <- read.csv(paste(basedir, "/ReducedData/LL1_heter_1cm.csv", sep = ""), header = T)
##sum(j1[,1] == j2[,1]) == dim(j1)[1]